# 分片集群外网连接

出于安全考虑，京东云MongoDB实例默认不开启外网链接，但用户可通过控制台和OpenAPI自行开启外网访问权限。



## 前提条件

- MongoDB实例状态为运行，且计费状态正常。

- MongoDB需要通过控制台或OpenAPI开启外网连接，如果您未开启外网连接，请先开启外网连接。

- 若您未设置密码，请优先设置密码，具体路径请参考[修改密码](../Reset-Password.md)文档。

- 请优先检查您的白名单设置，以防出现无法连接的情况。

  

## 注意事项

- 京东云提供单点连接Shard节点的功能，但Shard节点连接时使用的账号及密码不同于连接Mongos的账号密码。

- 在开启Shard内网或外网连接时，您可以通过控制台设置Shard连接认证所需的账号及密码，此账号密码内外网连接通用。

- 当您忘记Shard节点连接的账号密码时，请您关闭Shard节点的内网和外网连接后重新开启重新射中连接所需的账号密码。目前京东云不提供开启内外网连接后修改Shard连接验证账号和密码的修改功能。

- 由于外网域名生效需要一定时间，请耐心等待3-5分钟。

- 每次开启外网访问，访问域名会发生变化，若长时间保持外网访问，则访问域名固定。

- 在分片集群架构中，数据的读写通常以Mongos为入口，京东云在开启内外网连接时会默认开启所有Mongos的连接，您可以根据业务需求逐个开启Shard节点。

  

## 操作步骤

1. 打开[MongoDB控制台](https://mongodb-console.jdcloud.com/mongodb)，在实例列表页面找到目标实例;

2. 点击需要进行连接的实例进入**实例详情**页;

3. 点击上方标签栏的**数据库连接**进入管理界面，进入后选择**外网连接**;

   ![img](../../../../../image/mongodb/openShardInternet.png)

   

4. 分片集群由Mongos、Config server和Mongod组成，在本页面可选择开启Mongos、Shard/Config server的外网连接，以获得其外网域名。

   - 若您当前实例从未开启Shard的内网或外网连接，您需要针对Shard单独设置账号密码，当您点击开启外网连接后，您需要在弹窗内填写账号密码，账号不可为root；

   - 若您已经开启过Shard的内网连接，您无须设置账号密码，使用内网连接开启时设置的账号密码即可。

5. 稍等3-5分钟后刷新页面可获得节点外网连接域名，具体字段说明如下：

| 字段               | 字段说明                                                     |
| ------------------ | ------------------------------------------------------------ |
| 副本集名称         | 副本集的唯一识别ID                                           |
| 内网域名           | 副本集内除隐藏节点外所有内网节点域名，分片集群默认1主1从1隐藏，可直接查看Shard节点中的Primary和Secondary节点域名 |
| 外网域名（需开启） | 副本集内除隐藏节点外所有外网节点域名，分片集群默认1主1从1隐藏，可直接查看Shard节点中的Primary和Secondary节点域名 |



# 外网连接方式示例

Mongo Shell连接：

```
mongo mongodb://user:****@jmongo-xxx.jmiss.jdcloud.com:27017/admin
```

如当前实例支持IPv6，需使用‘--ipv6’指定，命令样式如下：

```
mongo mongodb://user:****@jmongo-xxx.jmiss.jcloud.com:27017/admin --ipv6
```

Connection String URI连接：

```
mongodb://user:****@jmongo-xxx.jmiss.jdcloud.com:27017/admin
```

请将user替换成您设置的账号，将\****替换成您所设定的密码，即连接Mongos使用root账号，其他节点连接需使用您的自定义账号。

