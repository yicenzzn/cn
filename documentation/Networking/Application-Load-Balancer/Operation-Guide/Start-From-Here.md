
# 配置导览

应用负载均衡主要由以下五部分组成：应用负载均衡实例、监听器、后端服务、虚拟服务器组或者高可用组。创建应用负载均衡及其相关组件、模块时，相互之间存在依赖关系，因此需要按照一定顺序进行创建设置；同样，删除应用负载均衡及其相关组件、模块时，也需要按照一定顺序进行删除。

具体顺序请参考下图所示：

 ![ALB创建流程](../../../../image/Networking/ALB/ALB-013.png)

 ![ALB删除流程](../../../../image/Networking/ALB/ALB-014.png)

## 应用负载均衡实例配置

- 基本属性配置：需要为应用负载均衡设置名称，用于区别不同的应用负载均衡实例；需要指定应用负载均衡实例所属的可用区、私有网络、子网。

	注意：
	
	1、应用负载均衡只能选择同私有网络下的后端服务器进行流量分发；
	
	2、应用负载均衡只能选择有应用负载均衡实例的可用区内的后端服务器进行流量分发。

- 配置安全组：创建应用负载均衡时需指定绑定的安全组，默认为端口全开的安全组。

- 公网/内网类型：创建应用负载均衡实例可选择是否绑定公网IP，绑定了公网IP的应用负载均衡即为公网类型，可提供面向公网的流量转发服务，不绑定或解绑公网IP后的应用负载均衡即为内网类型的应用负载均衡，可提供内网流量转发服务。


## 监听器配置

### 监听协议/端口

- 监听协议：目前提供HTTP、HTTPS、TCP、TLS、UDP协议的监听服务。

- 端口：应用负载均衡实例用于接收请求的监听端口，同一应用负载均衡实例下不可重复。

- 后端服务：定义自应用负载均衡至后端服务器的流量调度策略、配置等，详见下文。

## 后端服务

### 转发协议/端口

- 后端协议：目前提供HTTP、TCP、UDP协议的后端转发服务。

- 端口：应用负载均衡后端服务器上开放的用于接收请求的后端端口，不同监听器下后端端口可重复。

### 调度算法

目前应用负载均衡支持加权轮询、加权最小连接数、源IP转发3种转发规则。

- 加权轮询：轮询会将请求依次转发至后端服务器，配置了权重后会将流量按权重比例分发，配置权重越高的服务器被分发的几率越大；

- 加权最小连接数：配置了最小连接数会将请求转发至后端连接数最少的一台服务器，配置了权重后会将流量按权重比例分发，最终保证应用负载均衡与后端服务之间的活跃连接数比例与权重比例一致；

- 源IP转发：配置了源IP转发会将来自同一IP的客户请求转发至后端同一台服务器，保证服务的连贯性。

### 会话保持

应用负载均衡支持基于HTTP、HTTPS监听的会话保持，目前支持植入cookie的方式，将相同来源的访问请求转发至同一后端服务器。会话保持默认关闭，可以开启。

### 获取来访者真实IP

- 针对HTTP服务，由于采取替换HTTP头文件的方式来进行请求转发，所以后端云服务器看到的访问IP是应用负载均衡系统的本地IP而不是来访者的真实IP，系统支持用户采用X-Forwarded-For的方式获取访问者真实IP，系统默认开启7层（HTTP协议）服务监听的“获取真实IP”功能，不可关闭。

- 针对TCP、UDP服务，基于proxy protocol v1协议提供客户端IP透传，默认关闭，可以开启。

### 健康检查

用户开启健康检查功能后，当检测到后端某台服务器出现问题时会自动停止对该服务器的流量转发并将流量转发至其他健康的服务器，当故障的服务器恢复正常后会自动恢复流量转发。

针对HTTP服务，应用负载均衡健康检查机制为：默认由应用负载均衡系统通过后端服务器内网地址来向该服务器配置的应用服务器发起http head请求，如缺省检查端口则通过业务转发端口进行访问；

用户也可以指定用作健康检查的URL及健康检查超时时间、检查间隔、健康阈值、不健康阈值、正常状态返回码等来更好的控制健康检查功能。

TCP/HTTP/UDP参数配置参考建议如下，请根据业务具体情况自动调整

- 响应超时时间：5000毫秒

- 健康检查间隔：3000毫秒

- 不健康阈值：3次

- 健康阈值：3次

### 后端服务器

后端服务可选择绑定虚拟服务器组或高可用组。

## 虚拟服务器组

需配置虚拟服务器组名称、端口、权重，权重越高的服务器将被分配到更多的访问请求，可根据实际业务需求进行设置。

## 高可用组

一组支持批量创建、根据业务负载进行弹性伸缩的云主机实例，支持跨可用区、同机房跨机柜的高可用服务，可挂载至应用负载均衡后端，高可用组默认使用所绑定后端服务的转发端口，组内实例权重相同。



