# 负载均衡

## 产品概述

负载均衡可将大并发流量分发到多台后端实例（专指云物理服务器），调整资源利用情况，消除由于单台设备故障对系统的影响，提高系统的可用性、扩展服务能力，目前提供基于4层（TCP、UDP）、7层（HTTP、HTTPS）的流量监听、转发服务。负载均衡又称“物理云负载均衡”。

## 使用限制

您在使用负载均衡时请注意以下使用限制。

1、目前每个京东云账户支持每个地域（region）最多申请10个负载均衡，如需更多配额请提交工单申请。目前开放华北-北京地域。<br/>

2、负载均衡支持与弹性公网IP进行1:1绑定。<br/>

3、一个负载均衡实例可以添加多个监听器，上限为50个。<br/>

4、一个负载均衡可以添加多个虚拟服务器组，上限为20个。<br/>

5、一个虚拟服务器组组内可以添加100个实例。<br/>

6、目前包年包月的资源不允许删除。<br/>

## 计费概述

负载均衡支持包年包月和按配置两种计费方式，目前均免费。

**开通要求**

开通要求：为保证您的正常使用，开通按配置计费时您的账户余额及可用代金券之和不低于消费门槛50元（如果负载均衡绑定弹性公网IP，弹性公网IP会收取费用）。

**到期/欠费**

负载均衡实例免费，自身不存在欠费情况。如果负载均衡绑定的弹性公网IP欠费，将影响弹性公网IP的使用，此时对公网流量进行负载均衡的功能将不能使用。

**计费规则**

目前使用负载均衡产品免费，如绑定了弹性公网IP资源，仅需单独支付弹性公网IP费用，详见弹性公网IP[价格总览](../../Pricing/Price-Overview.md)。

**价格总览**

目前购买使用包年包月&按配置计费方式的负载均衡实例，所有Region均免费。

## 续费流程

**续费规则**

包年包月计费实例续费：延长包年包月负载均衡的使用时长。续费时间段为1个月~9个月、1年、2年、3年。如您在实例到期前操作续费，则新订单的开始时间为原订单的到期时间；如您在资源到期后续费，则新订单的开始时间为续费当天。

关联续费：（前提：负载均衡实例绑定了弹性公网IP）实例进行续费时，会显示该实例绑定的弹性公网IP，用户可按需选择需一同续费的关联资源进行续费。

## 操作指南

负载均衡主要由以下部分组成：负载均衡实例、监听器、虚拟服务器组。

## 负载均衡实例

**创建负载均衡实例**

进入负载均衡实例列表页，点击 **创建** ，根据需求选择 **地域** ，**网络**--网络类型（仅支持公网），IP版本（仅支持IPv4），私网网络，绑定的服务器类型（仅支持云物理服务器），**基本信息**--输入实例名称，描述，支持添加标签（最多可添加10个标签），**带宽**--勾选弹性公网IP，选择带宽计费模式，线路类型，带宽上限，也支持暂不购买（待实例创建完成后再绑定弹性公网IP），**购买量**--选择购买时长，**自定续费**--默认包年包月计费类型选中自动续费，也支持用户取消自动续费，点击 **确定** ，即可创建一个负载均衡。<br/>

**绑定公网IP**

进入负载均衡实例列表页，选择目标负载均衡，点击 **绑定公网IP** ，选择所需的弹性公网IP，即可绑定成功。<br/>

**解绑公网IP**

进入负载均衡实例列表页，选择目标负载均衡，点击 **解绑公网IP** ，即可将弹性公网IP解绑，解绑后负载均衡可绑定新的IP。<br/>

**编辑标签**

进入负载均衡实例列表页，选择目标负载均衡，点击 **编辑标签** ，即可编辑标签。<br/>

**删除实例**

进入负载均衡实例列表页，选择目标负载均衡，点击 **删除** ，即可删除负载均衡。<br/>
说明：<br/>
1、包年包月计费方式负载均衡不支持删除，仅按配置计费方式支持删除操作；<br/>
2、实例删除后，所关联的监听器、虚拟服务器组均删除，且不可恢复；<br/>
3、实例删除后，后端云物理服务器将继续保留，如不需保留，请前往对应页面删除，以免产生额外费用。<br/>

**开启/关闭实例**

进入负载均衡实例列表页，选择目标负载均衡，点击 **开启** ，可启动负载均衡。说明：若负载均衡未绑定弹性公网IP，则不支持“开启”；同理，点击 **关闭** ，可停止负载均衡。<br/>

**查看实例详情**

进入负载均衡实例列表页，选择目标负载均衡，点击**ID/实例名称**,跳转到实例详情页，可查看实例详细信息。<br/>

## 监听器管理

**添加监听**

进入负载均衡实例列表页，选择目标负载均衡，点击**添加监听**，跳转到监听器列表页；或者进入负载均衡实例详情页-监听器tab页-监听器列表页，点击**创建监听器**，根据需求选择，<br/>

**基本配置--**<br/>
**名称**：所输入的监听器名称（同一用户下负载均衡实例名称不能重复）；<br/>
**监听协议**：支持四层和七层，其中四层包括TCP和UDP协议，七层包括HTTP和HTTPS协议；<br/>
**端口**：监听规则创建后，协议和端口不允许修改。负载均衡对外提供的端口，通常TCP/HTTP使用80，HTTPS使用443；<br/>
**会话保持**：会话保持默认关闭，开启会话保持可以将同一客户端的请求始终转发给同一服务器。后端协议为HTTP或HTTPS时支持植入cookie和重写cookie会话保持；<br/>
**调度算法**：支持加权轮询、加权最小连接数、源IP、IP哈希。根据需求选择。**加权轮询**：加权轮询会将访问请求依序分发后端服务器，权重值越高的后端服务器，被轮询到的次数（概率）也越高。**加权最小连接数**：除了根据每台后端服务器设定的权重值来进行轮询，同时还考虑后端服务器的实际负载（即连接数）。当权重值相同时，当前连接数越小的后端服务器被轮询到的次数（概率）也越高。**源IP**：基于源IP地址的一致性hash，相同的源地址会调度到相同的后端服务器。**IP哈希**：每个请求按访问负载均衡的客户端IP进行哈希分配，来自同一个客户端的请求会被分发给同一个后端服务器。<br/>
**HTTP2.0**：当HTTPS协议启用HTTP 2.0后，LB可以接收HTTP 2.0请求，无论客户端请求 SLB 时使用哪种 HTTP 版本，LB 访问后端服务器的 HTTP 版本都是 HTTP 1.1。<br/>
**获取真实IP**：协议为TCP时，默认为关闭，如果开启需要用户设置：通过yum源安装。以Centos为例，使用yum install kmod-toa安装toa内核模块插件后，可通过socket.accept()返回参数或调用 socket.getpeername()获取真实源IP。协议为HTTP或HTTPS时，此时可通过X-Forwarded-For头字段获取客户端真实IP；<br/>
**获取HTTP头字段**：用于透传客户端HTTP或HTTPS请求的相关信息。支持通过X-Forwarded-For字段获取客户端真实IP、通过X-Forwarded-Proto字段获取负载均衡监听协议、通过X-Forwarded-Port字段获取负载均衡监听端口、 通过X-Forwarded-LBIP字段获取负载均衡的公网IP；<br/>
**域名**：协议为HTTPS时，支持设置域名，用于不同的域名可使用不同的证书；<br/>
**证书**：协议为HTTPS时，支持绑定证书；<br/>

**健康检查**--负载均衡实例可以定期向后端服务器发送 Ping、尝试连接或发送请求来测试后端服务器运行的状况；<br/>
**健康检查**：默认开启（若关闭，以下字段均不显示）；<br/>
**响应超时时间**：健康检查响应的最大超时时间，如后端云服务器在相应时间内没有正确响应，则判定为健康检查失败。限制：2-60s。响应超时时间必须小于健康检查间隔。默认值是3。<br/>
**健康检查间隔**：进行健康检查的时间间隔。限制：5-300s，默认值是5。<br/>
**健康阈值**：表示后端实例从失败到成功的连接健康次数。限制：1-10次，默认值是3。<br/>
**不健康阈值**：表示后端实例从成功到失败的连接健康检查失败次数。限制：1-10次，默认值是3。<br/>
**检查路径**：健康检查的URL路径。必须以“/”开头，不得超过100字符。仅健康检查方式为HTTP或HTTPS时支持填写。<br/>
**正常态码**：输入范围2xx（等价于200-299）、3xx（等价于300-399）、4xx（等价于400-499）。仅健康检查方式为HTTP或HTTPS时支持填写。<br/>
**健康检查IP**：100.64.0.0/10<br/>

**后端服务器**--<br/>
选择虚拟服务器组，若没有已创建的服务器组，点击 **添加服务器器组** ，支持添加单网口或者双网口服务器，也支持指定服务器的内网IP或者别名IP,选择完成后即可创建。<br/>

完成以上步骤，点击**确定**，监听器即可创建成功。

**查看监听器详情**

进入监听器列表页，点击**名称**，跳转到监听器详情页，可查看监听器详细信息。<br/>

**编辑监听器**

进入监听器列表页，选中目标监听器，点击“编辑”按钮，即可进行编辑操作。说明：监听端口及协议不可修改，其余字段可以修改<br/>

**开启/关闭监听器**

进入监听器列表页，点击 **开启** ，可启动监听器。同理，点击 **关闭** ，可停止监听器。<br/>

**删除监听器**

进入监听器列表页，点击 **删除** ，即可删除监听器。监听器删除后，相应的后端服务器也将与此监听器解除绑定关系。<br/>

**SNI管理**

监听器HTTPS协议支持SNI，即不同的域名配置不同的证书。支持同一个监听器不同的域名配置不同的证书。<br/>

进入监听器-HTTPS监听器详情页，点击“SNI管理”tab页，点击“添加扩展证书”，输入扩展域名，选择对应的证书，点击“确认”按钮，即添加完成。<br/>

**访问控制**

访问控制：使用负载均衡的用户可以通过添加白名单和黑名单的ACL规则来控制访问七层负载均衡监听器的IP地址/地址段，通过设置入方向的允许或拒绝规则，对客户端请求精确控制，管理请求转发。<br/>

ACL规则：依据访问客户端IP地址，从ACL规则列表按序号顺序匹配IP地址/地址段，第一个匹配的ALC规则被执行。白名单规则表明显式放行，黑名单规则表明显式拒绝，无论黑白ACL规则，先匹配到的规则被执行，并忽略与之冲突的任意更高编号的规则。<br/>

ACL列表中系统默认规则是999全放行，其余规则用户可根据需求匹配黑白名单规则。<br/>

**个性化配置**

七层负载均衡支持个性化配置，允许用户设置单监听器的个性化配置项。<br/>

进入负载均衡-HTTP/HTTPS监听器详情页-“个性化配置”tab页，根据需求设置参数。目前支持ssl_ciphers，ssl_protocols，keepalive_timeout，proxy_read_timeout，proxy_connect_timeout，proxy_send_timeout对以上6个参数进行个性化配置。<br/>

## 虚拟服务器组管理

**添加虚拟服务器组**

进入虚拟服务器组tab页，点击 **添加虚拟服务器组** ，输入**虚拟服务器组名称**、选择实例、端口等信息，点击**确定**，虚拟服务器组即创建完成。<br/>

**查看虚拟机服务器组**

进入虚拟服务器组tab页，点击**虚拟服务器组**名称，进入虚拟服务器组详情页，查看详细信息。<br/>

**编辑虚拟机服务器组**

进入虚拟服务器组tab页，选择目标虚拟服务器组，点击 **编辑**操作，支持对其进行修改。<br/>

**删除**

进入虚拟服务器组tab页，选择目标虚拟服务器组，点击 **删除**操作，支持对其进行删除。<br/>
删除条件：不与任何监听器绑定。<br/>
