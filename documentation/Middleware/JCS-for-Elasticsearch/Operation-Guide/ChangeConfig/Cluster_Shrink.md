# 降配集群

当您的业务存在高低峰期或其他变化，导致集群节点规格高于业务所需规格时，可通过京东云搜索 Elasticsearch 的集群降配功能，降低节点规格配置，以更好地保障业务发展并控制成本。
本文介绍了京东云 Elasticsearch 降配集群的操作方法、相关说明和注意事项。

## 前提条件
- 集群为正常状态（绿色）。如果集群为非正常状态（黄色或红色），请待集群恢复正常状态（绿色）再降配集群。
- 请结合规格容量评估和使用限制，确保确保降配后集群有足够的存储空间，评估方法，请参见 [规格容量评估](../../Best-Practices/Capacity-Assessment.md)。如果降配后集群负载较高，建议及时升配，具体操作请参见 [升配集群](../ChangeConfig/Cluster_Expansion.md)。
- 检查集群负载，建议集群满足以下条件时进行降配操作，如集群负载过高可能会影响集群的稳定性，请谨慎操作。
  集群中中可能包含多种类型的节点。节点类型不同，当前CPU使用率和JVM堆内存使用率的建议不同，具体如下。</br>
    | 节点类型 | 当前CPU使用率 | 当前JVM堆内存使用率 |
    | :-- | :-- | :-- |
    | 专有主节点 | 单节点最大值 < 30% | 单节点最大值 < 25% |
    | 数据节点 | 同时满足以下条件：</br> - 单节点最大值 < 60% </br> - 所有节点平均值 < 40% | 同时满足以下条件：</br> - 单节点最大值 < 50% </br> - 所有节点平均值 < 30% |
    | 协调节点 | 同时满足以下条件：</br> - 单节点最大值 < 50% </br> - 所有节点平均值 < 30%  | 同时满足以下条件：</br> - 单节点最大值 < 50% </br> - 所有节点平均值 < 30% |
    | 冷数据节点 | 同时满足以下条件：</br> - 单节点最大值 < 60% </br> - 所有节点平均值 < 40%  | 同时满足以下条件：</br> - 单节点最大值 < 50% </br> - 所有节点平均值 < 30% |
- 检查集群中是否存在 **状态为 close 的索引**。如果存在，需要将 **对应索引的状态暂时设置为Open，否则变更不成功**。
  - 登录 Kibana 控制台，执行以下命令，查看索引状态。

  ```
  GET /_cat/indices?v
  ```
  
  - 将close状态的索引暂时设置为open状态。<index_name>需要替换为状态为close的索引名称。
  ```
  POST /<index_name>/_open
  ```
  </br>


## 使用限制
- 每次只能变更一种节点类型（数据节点、冷数据节点、专有主节点、协调节点）的规格配置。
- 云盘型数据节点或者冷数据节点的存储空间，不支持降配操作。
- 系统只展示可变更的规格。</br>
  降配所选的目标规格的CPU和内存均需大于或等于当前规格的1/2，且不支持将节点规格降配至1核2 GB。
- 对于多可用区实例，在变更时，需要确保集群中任意一个索引的副本数都小于可用区数。待变更完成后，您可以根据业务手动增加副本数。   

 </br>
 
## 注意事项

### 服务影响
- 降配集群会触发集群重启，
  - 重启方式为滚动重启。重启不会导致服务中断，但可能会影响集群的稳定性，例如节点CPU和内存使用率临时突增，为了减少对业务的影响，建议在业务低峰期操作。
  - 重启时间与集群规格、数据结构和大小等因素有关，一般情况下，重启耗时较长，在小时级别。


### 计费变化
提交了降配订单后，集群将按照更新后的订单计费。计费规则，请参见 [计费规则](../../Pricing/Billing-Rules.md)。
- 对于按配置计费实例，调整配置后将按照新规格计费，调整前规格会立即出账结算（即对上次整点结算时间至当前时间产生的费用进行结算）；
- 对于包年包月计费云主机：
  - 若调配后规格价格低于调配前规格价格，则将延长云主机到期时间；
  - 若调配后规格价格高于调配前规格价格，需要支付到期前的差价。

> 说明：在降配集群时，您可以在变配页面，实时观察更新后的订单消费金额。

### 分片分配
- 变更节点数后，集群不会自动重新规划分片，可能导致数据在分片上的分配不均匀。

 </br>
 
## 操作步骤
1. 访问 [云搜索Elasticsearch控制台](https://es-console.jdcloud.com/clusters)，进入集群管理页面。或访问 [京东云控制台](https://console.jdcloud.com/)，点击顶部导航栏 互联网中间件-云搜索Elasticsearch，进入集群管理页。
2. 在您要变更配置的集群，选择 【**操作-更多-变更配置**】。
3. 在变更配置页面，展示了当前集群的配置信息，便于您在执行降配操作时参考。根据实际业务需求，通过页面提示修改实例配置。部分参数说明如下。</br>

| 参数 | 说明 |
| :-- | :-- |
| 数据节点 | - 当数据节点为**云盘型**时，您可以降配**节点规格**。</br> - 当数据节点为**本地盘型**时，您可以降配**节点规格**（**限制条件：必须已经开启专有主节点**）。|
| 专有主节点 | 支持降配已购买的专有主节点的规格。 详细信息，请参考 [专有主节点](../../Operation-Guide/Instance/Nodes/Dedicated-master-node.md)|
| 协调节点 | 支持降配已购买的协调节点的规格。 详细信息，请参考 [协调节点](../../Operation-Guide/Instance/Nodes/Coordinating-node.md)|
| 冷数据节点 | 支持降配**节点规格**。详细信息，请参考 [冷数据节点](../../Operation-Guide/Instance/Nodes/Warm-Node.md)。|

</br>

![Cluster_nodes_shrink_1](../../../../../image/Elasticsearch/ChangeCfg/Cluster_nodes_shrink_1.png)

4. 确认变更配置后，点击 **变更** 按钮。
5. 在订单确认页，确认订单新和应付金额后，选中 **已阅读并同意《云搜索Elasticsearch服务条款》**，点击 **立即支付**。支付完成后，集群会重启，重启成功后即可完成集群降配。
